name: "terraform_gate"

on:
  workflow_run:
    workflows: ["terraform_check"]
    types:
      - completed

jobs:
  terraform_gate:
    name: "terraform_gate"
    runs-on: ubuntu-latest
    if: >
      ${{ github.event.workflow_run.conclusion == 'success'}} &&
      contains(github.event.pull_request.labels.*.name, 'merge')

    defaults:
      run:
        shell: bash

    steps:
      - name: "Checkout"
        uses: actions/checkout@v3

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v2

      - name: "Terraform Init"
        run: terraform init

      - name: "Terraform Apply"
        run: terraform apply -auto-approve